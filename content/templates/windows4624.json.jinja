{% set host_name = params.dc_hostname -%}
{% set domain_name = params.domain_name -%}

{% set target_user_name = (samples.names | random)[0].replace(" ", "") -%}

{% set agent_name = host_name + "." + domain_name -%}
{% set subject_user_name = host_name.upper() + "$" -%}
{% set record_id = shared.get("record_id", 1) -%}
{% set process_id = range(1, 1024) | random -%}

{
    "@timestamp": "{{ timestamp }}{{ tz }}",
    "agent": {
        "ephemeral_id": "53889096-967d-4626-8c5c-9ec81f6bbc50",
        "id": "3cdc1e10-ded0-4f5d-8434-ede1d1120b17",
        "name": "{{ agent_name }}",
        "type": "winlogbeat",
        "version": "8.0.0"
    },
    "ecs": {
        "version": "8.0.0"
    },
    "event": {
        "action": "logged-in",
        "category": [
            "authentication"
        ],
        "code": "4624",
        "kind": "event",
        "outcome": "success",
        "provider": "Microsoft-Windows-Security-Auditing",
        "type": [
            "start"
        ]
    },
    "host": {
        "name": "{{ host_name }}",
        "os": {
            "family": "windows",
            "type": "windows"
        }
    },
    "process": {
        "executable": "C:\\Windows\\System32\\services.exe",
        "name": "services.exe",
        "pid": {{ process_id }}
    },
    "related": {
        "user": [
            "{{ target_user_name }}",
            "{{ subject_user_name }}"
        ]
    },
    "user": {
        "domain": "{{ domain_name }}",
        "id": "S-1-5-18",
        "name": "{{ target_user_name }}"
    },
    "winlog": {
        "channel": "Security",
        "computer_name": "{{ host_name }}",
        "event_data": {
            "AuthenticationPackageName": "Negotiate",
            "ImpersonationLevel": "%%1833",
            "IpAddress": "-",
            "IpPort": "-",
            "KeyLength": "0",
            "LmPackageName": "-",
            "LogonGuid": "{00000000-0000-0000-0000-000000000000}",
            "LogonProcessName": "User32",
            "LogonType": "2",
            "SubjectDomainName": "{{ domain_name }}",
            "SubjectLogonId": "0x3e7",
            "SubjectUserName": "{{ subject_user_name }}",
            "SubjectUserSid": "S-1-5-18",
            "TargetDomainName": "{{ domain_name }}",
            "TargetLogonId": "0x3e7",
            "TargetUserName": "{{ target_user_name }}",
            "TargetUserSid": "S-1-5-21-{{ module.rand.string.digits(10) }}-{{ module.rand.string.digits(10) }}-{{ module.rand.string.digits(8) }}-{{ range(1000, 10000) | random }}",
            "TransmittedServices": "-"
        },
        "event_id": "4624",
        "keywords": [
            "Audit Success"
        ],
        "level": "information",
        "logon": {
            "id": "0x3e7",
            "type": "Service"
        },
        "opcode": "Info",
        "outcome": "success",
        "process": {
            "pid": {{ process_id }},
            "thread": {
                "id": {{ range(1, 1024) | random }}
            }
        },
        "provider_guid": "{54849625-5478-4994-a5ba-3e3b0328c30d}",
        "provider_name": "Microsoft-Windows-Security-Auditing",
        "record_id": "{{ record_id }}",
        "time_created": "{{ timestamp }}{{ tz }}",
        "@version": 1
    }
}
{%- do shared.set("record_id", record_id + 1) %}